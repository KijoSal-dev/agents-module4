# AI Code Review Report

## Summary

This review covers changes across `AI_CODE_REVIEW.md`, `index.ts`, and `tools.ts`. The primary objective of these changes is to enhance the code review agent's functionality to support both **staged** and **unstaged** changes, providing greater flexibility and utility. The implementation is generally clear, correct, and improves the robustness of the tool.

## File-by-file Feedback

### `AI_CODE_REVIEW.md`

- **Correctness & Intent:** This appears to be a newly staged file that currently contains a message indicating no staged changes were found.
  - **Suggestion:** If this file is intended to be dynamically generated by the `generateMarkdownReportTool`, it should typically not be committed in this state. If it's a template or example, consider removing the "No staged changes..." message or ensuring it's clearly marked as a placeholder. It's often better to keep generated files out of version control, or to ensure they are properly reset before committing.

### `index.ts`

```typescript
// ... (imports)

/**
 * Run AI-powered code review
 */
const codeReviewAgent = async (absDir: string, mode: "staged" | "unstaged") => {
  const result = streamText({
    model: google("models/gemini-2.5-flash"),
    prompt: `
You are reviewing code in: ${absDir}

1. Use the \`getFileChangesInDirectoryTool\` to fetch **${mode} changes**.
2. Provide a detailed review (correctness, clarity, maintainability, etc.).
3. Use the \`generateCommitMessageTool\` to propose a commit message.
4. Use the \`generateMarkdownReportTool\` to save the full review into a Markdown file.
`,
    tools: [
      getFileChangesInDirectoryTool,
      generateCommitMessageTool,
      generateMarkdownReportTool,
    ],
  });

  for await (const chunk of result.textStream) {
    process.stdout.write(chunk);
  }
};

// ‚úÖ CLI args
const targetDir = process.argv[2] || "./"; // default current dir
const modeArg = process.argv[3] === "--unstaged" ? "unstaged" : "staged"; // default staged
const resolvedDir = path.resolve(targetDir);

await codeReviewAgent(resolvedDir, modeArg);
```

- **Clarity & Maintainability:**
    - The modification of the `codeReviewAgent` function to accept `absDir` and `mode` directly is a good refactor. It makes the function's dependencies explicit and improves its reusability.
    - The prompt update to dynamically include `${mode} changes` is a clear improvement, ensuring the AI agent is aware of the specific review scope.
- **Correctness:**
    - The addition of CLI argument parsing for `modeArg` using `--unstaged` is well implemented and allows users to easily switch between reviewing staged and unstaged changes.
    - Using `path.resolve(targetDir)` ensures that the directory path is always absolute, which is generally good practice for consistency and avoiding path-related issues.

### `tools.ts`

```typescript
import { tool } from "ai";
import { z } from "zod";
import simpleGit from "simple-git";
import path from "path";

const excludeFiles = ["dist", "bun.lock"];

/**
 * Schema for directory input (with mode)
 */
const fileChange = z.object({
  rootDir: z.string().min(1).describe("The root directory"),
  mode: z
    .enum(["staged", "unstaged"])
    .default("staged")
    .describe("Whether to get 'staged' or 'unstaged' changes"),
});

type FileChange = z.infer<typeof fileChange>;

/**
 * Tool: Get file changes in a Git directory
 */
async function getFileChangesInDirectory({ rootDir, mode }: FileChange) {
  const git = simpleGit(rootDir);

  // Decide whether to look at staged or unstaged changes
  const args = mode === "staged" ? ["--cached"] : [];
  const summary = await git.diffSummary(args);

  const diffs: { file: string; diff: string }[] = [];

  for (const file of summary.files) {
    if (excludeFiles.includes(file.file)) continue;
    const diff = await git.diff([...args, "--", file.file]);
    diffs.push({ file: file.file, diff });
  }

  return diffs.length > 0
    ? diffs
    : [`‚ÑπÔ∏è No ${mode} changes found in ${rootDir}`];
}

export const getFileChangesInDirectoryTool = tool({
  description: "Gets the code changes in a given directory (staged or unstaged)",
  inputSchema: fileChange,
  execute: getFileChangesInDirectory,
});

const commitMessageSchema = z.object({
  message: z.string().min(1),
});

export const generateCommitMessageTool = tool({
  description: "Generates a commit message for the staged or unstaged changes",
  inputSchema: commitMessageSchema,
  async execute({ message }) {
    return `üí° Suggested commit message:\n\n${message}`;
  },
});
```

- **Correctness & Robustness:**
    - The introduction of `mode` to the `fileChange` schema and its use in `getFileChangesInDirectory` is a robust way to distinguish between staged and unstaged changes.
    - Using `args` array for `git.diffSummary` and `git.diff` dynamically based on `mode` is correct and efficient.
    - **Excellent Improvement:** The change to return a user-friendly message (`‚ÑπÔ∏è No ${mode} changes found in ${rootDir}`) instead of an empty array when no changes are detected significantly improves the tool's robustness and user experience. It provides clear feedback in a common edge case.
- **Clarity & Maintainability:**
    - The updated `description` for `getFileChangesInDirectoryTool` and `generateCommitMessageTool` clearly communicates their expanded functionality.
    - The `mode` enum in the `fileChange` schema with a default of `"staged"` provides clear expectations for the tool's input.
- **Consistency:**
    - The new prefix `üí°` for the `generateCommitMessageTool`'s output is a nice touch for consistent and visually distinct messaging.

## Suggested Commit Message

feat: Add support for staged and unstaged code reviews

This commit introduces the ability to perform AI-powered code reviews on both staged and unstaged changes within a Git repository.

- `index.ts` now accepts a `mode` argument via CLI (`--unstaged`) to specify the review scope.
- `tools.ts` has been updated to handle `staged` or `unstaged` modes when fetching file changes and generating commit messages.
- Improved feedback when no changes are found for review.